---
title: "Process_PigmentsData"
author:
- Sylwia Sliwinska-Wilczewska
- Douglas A. Campbell
date: "`r format(Sys.Date())`"
output:
bookdown::html_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_float: TRUE
    toc_depth: 6
    fig_caption: yes
bibliography: BalticPhotoperiod.bib
csl: plos-one.csl
editor_options: 
  markdown: 
    wrap: 72
---

# Set Chunk Options

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

# Introduction

Process_PigmentsData.Rmd processes BalticPhotoperiod_Imported_PigmentsData.Rds from Data/ImportedData/ImportedPigmentsData. This .Rmd generates BalticPhotoperiod_Processed_PigmentAll.Rds and BalticPhotoperiod_Processed_PigmentsExp.Rds (both stored in Data/ProcessedData/ProcessedPigmentsData folder) and one plots (stored in Output/Figures folder).

# Load Libraries and set Project Variables

```{r load libraries} 
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(OneR)
library(zoo)
library(strucchange)
library(ggpubr)
library(caret)
library(googledrive)
library(googlesheets4)
library(readxl)
library("patchwork") # merging plots
```

```{r set project variables}
Project <- "BalticO2"
DataOut <- file.path("..", "Data", "ProcessedData", "ProcessedPigmentsData")
DataIn <- file.path("..", "Data", "ImportedData", "ImportedPigmentsData", fsep = .Platform$file.sep)

FigPath <- file.path("..", "Output", "Figures")
FigRdsPath <- file.path("..", "Output", "FiguresRds")
TableRdsPath <- file.path("..", "Output", "TablesRDS")

FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```

# List and read files

```{r Exported Rmd only first time in session}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

```{r read pigments File}
#df ontained mean OD per day from Multiculti and Abs from Olis spectra for selected nm. Based on this I calculated pigments per mL and per cell (pg/cell)

MCPigmentFile <- "../Data/ImportedData/ImportedPigmentsData/BalticO2_Imported_PigmentsData.Rds"
MCPigmentFileName <- str_split(string = MCPigmentFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
MCPigment <- readRDS(MCPigmentFile)  %>%
  ungroup()
```

I got a NA in some places b/c I do not measure Olis every day (MC df contain OD for every day and every h but I would like to keep all this data

# Preparing df for further analysis - selected unrevelant columns

```{r Preparing df for further analysis}
MCPigment<-MCPigment %>% 
  # drop_na(MC) %>%
  select(-c(Abs480, Abs565, Abs620, Abs650, Abs665)) %>% 
  unique()
```

# Replace negative values in df to zero when no pigments

```{r Replace negative values, warning=FALSE}
MCPigment <- MCPigment
MCPigment[MCPigment < 0] <- 0
```

# Calculate number of cells per L and PUR/PAR ratio

```{r Calculate pigments per L}
MCPigment <- MCPigment %>%
  mutate(cellL_OD680=cellmL_OD680_MDPico*1000) %>% 
  mutate(PURPARRatio = PUR/Par_ue)
  # mutate(ChlaugL = ChlaugmL*1000) 
```

# Preparing df for plot

```{r Combine Chla, phyco, and Car in one column for final plot}
MCPigment1<-MCPigment %>% 
  select(-c(Chlapgcell, Carpgcell)) %>% 
  mutate(Pigmentspgcell=Phycopgcell*1) %>% 
  select(-c(Phycopgcell))
MCPigment1$PigmentsName = "Total~phycobilins"

MCPigment2<-MCPigment %>% 
  select(-c(Phycopgcell, Carpgcell)) %>% 
  mutate(Pigmentspgcell=Chlapgcell*1) %>% 
  select(-c(Chlapgcell))
MCPigment2$PigmentsName = "Chlorophyll~a"

MCPigment3<-MCPigment %>% 
  select(-c(Chlapgcell, Phycopgcell)) %>% 
  mutate(Pigmentspgcell=Carpgcell*1) %>% 
  select(-c(Carpgcell))
MCPigment3$PigmentsName = "Carotenoids"
  
MCPigmentPlot<-rbind(MCPigment1, MCPigment2, MCPigment3)

rm(MCPigment1, MCPigment2, MCPigment3)
```

# I have 24 measurements per pigment per day (b/c number of cells changes every h so pigments per cell changed as well)
# Choosen only ToD=10 to get only 1 value of pigment (b/c I measured Olis usually at 12pm). 

```{r}
MCPigmentPlot<-MCPigmentPlot %>%
  filter(ToD == 12) %>% 
  unique()
```


# Combine phyco/Chla ratio and car/chla ratio in one column for final plot

```{r Combine phyco/Chla ratio and car/chla ratio in one column for final plot}
MCPigmentRatio1<-MCPigmentPlot %>% 
  select(-c(PhycoChlaRatio)) %>% 
  mutate(PigmentsRatio=CarChlaRatio*1) %>% 
  select(-c(CarChlaRatio))
MCPigmentRatio1$PigmentsRatioName = "Car/Chl~a~ratio"

MCPigmentRatio2<-MCPigmentPlot %>% 
  select(-c(CarChlaRatio)) %>% 
  mutate(PigmentsRatio=PhycoChlaRatio*1) %>% 
  select(-c(PhycoChlaRatio))
MCPigmentRatio2$PigmentsRatioName = "Total~Phyco/Chl~a~ratio"

MCPigmentRatioPlot<-rbind(MCPigmentRatio1, MCPigmentRatio2)

rm(MCPigmentRatio1, MCPigmentRatio2)
```


```{r}
MCPigmentRatioPlot<-MCPigmentRatioPlot %>% 
  mutate(WLNum = if_else(WL == "WW", 750, as.numeric(WL))) %>%
  filter(WL != "WW") %>% 
  mutate(Oxygen=case_when(O2==21~"250~µM",
         O2==0~"2.5~µM"))

MCPigmentPlot<-MCPigmentPlot %>% 
  mutate(WLNum = if_else(WL == "WW", 750, as.numeric(WL))) %>%
  filter(WL != "WW") %>% 
  mutate(Oxygen=case_when(O2==21~"250~µM",
         O2==0~"2.5~µM"))
```

#Create preliminary plot

```{r preliminary plot}
lab1=c(expression("PC-rich_077"), expression("PE-rich_127"))

A<-MCPigmentRatioPlot %>%
  filter(E_days == 7 | E_days == 8| E_days == 6 | E_days == 5| E_days == 10) %>% 
  ggplot() +
  geom_point(aes(x = WLNum, y = PigmentsRatio, colour = as.factor(Strain), shape = as.factor(Photoperiod)),  alpha = 0.8, size = 3, show.legend = T) +
  scale_colour_manual(values = c("palegreen3", "brown4"), name="", labels = lab1) +
  scale_shape_manual(values = c(16, 18), name="", labels = lab1) +
  scale_linetype_manual(values = c("solid", "dashed"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(PigmentsRatioName), rows = vars(factor(Oxygen, levels=c("250~µM","2.5~µM"))), labeller = label_parsed) +
  theme_bw() 
A

B<-MCPigmentPlot %>%
  filter(E_days == 7 | E_days == 8| E_days == 6 | E_days == 5| E_days == 10) %>% 
  ggplot() +
  geom_point(aes(x = WLNum, y = Pigmentspgcell, colour = as.factor(Strain), shape = as.factor(Photoperiod)),  alpha = 0.8, size = 3, show.legend = T) +
  scale_colour_manual(values = c("palegreen3", "brown4"), name="", labels = lab1) +
  scale_shape_manual(values = c(16, 18), name="", labels = lab1) +
  scale_linetype_manual(values = c("solid", "dashed"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(PigmentsName), rows = vars(factor(Oxygen, levels=c("250~µM","2.5~µM"))), labeller = label_parsed) +
  theme_bw()
B
```

```{r}
ggp<- A/B
ggp  
```

# Save plot 

```{r save plot}
ggsave(file = file.path(FigPath, paste("Fig_Pigments",".png",sep = "")), height=8, width= 6,  dpi = 300, limitsize = TRUE)
```


# Make "one big - All" mean to combine all days (divided by Exp and St) and all replica when samples were measured 
(This give me only one value of Phyco/Chla ratio JVPSII plot and sig plot as well)

# Calculate one "big" mean from Phyco/Chla ratio from all data measured on Exp or St phase 
# AllmeanPhycoChlaRatio contains 1-7 measurements (different days)

```{r calculate Sigma mean from exp phase}
#E_days, Time_h, caused problem

MCPigmentChoosen<-MCPigment %>%
  drop_na(PhycoChlaRatio) %>% 
  group_by(Strain, Par_ue, Photoperiod, WL, O2) %>%

  summarize(SampleID, ToD, Run, Strain, ExpDate, FilenameMC, Tube, Par_ue, Photoperiod, O2, WL, MC, LightShape, ExpEndDate, meanActinic_par_h, meanOD680_h, meanOD720_h, meanDeltaOD_h, facetsPar_ue, facetsPhotoperiod, cellmL_OD680_MDPico, PARPhotonDose_day, PUR, PURPhotonDose_day, ChlaugmL, CarugmL, PEugmL, PCugmL, APCugmL, Chlapgcell, Carpgcell, PEpgcell, PCpgcell, APCpgcell, Phycopgcell, CarChlaRatio, PhycoChlaRatio, PEPCRatio, cellL_OD680, PURPARRatio, E_days, Oxygen,

            meanPhycoChlaRatio = mean(PhycoChlaRatio),
            sdPhycoChlaRatio = sd(PhycoChlaRatio),
            meanPURPARRatio = mean(PURPARRatio),
            sdPURPARRatio = sd(PURPARRatio)) %>%
  ungroup()
```

#Create preliminary plot

```{r preliminary plot}
lab1=c(expression("PC-rich_077"), expression("PE-rich_127"))

MCPigmentChoosen %>%
  mutate(WLNum = if_else(WL == "WW", 750, as.numeric(WL))) %>%
  filter(WL != "WW") %>%
  filter(E_days == 7 | E_days == 8| E_days == 6 | E_days == 5| E_days == 10) %>% 
  ggplot() +
  geom_point(aes(x = WLNum, y = meanPhycoChlaRatio, colour = as.factor(Strain), shape = as.factor(Strain)),  alpha = 0.8, size = 4, show.legend = T) +
  geom_line(aes(x = WLNum, y = meanPhycoChlaRatio, colour = as.factor(Strain), linetype = as.factor(Strain)), show.legend = F) +
  geom_errorbar(aes(x = WLNum, ymin = meanPhycoChlaRatio - sdPhycoChlaRatio, ymax = meanPhycoChlaRatio + sdPhycoChlaRatio, colour = as.factor(Strain)), width=0, size=0.3, show.legend = F) +
  
  geom_hline(yintercept=1, linetype = "dotted", size = 0.3) +
  
  scale_colour_manual(values = c("palegreen3", "brown4"), name="", labels = lab1) +
  scale_shape_manual(values = c(16, 18), name="", labels = lab1) +
  scale_linetype_manual(values = c("solid", "dashed"), name="", labels = lab1) +
  
  stat_wl_strip(aes(x = WLNum), ymin = -Inf, ymax = -0.025, alpha = 0.5) +
  scale_fill_identity() +
  labs(y = "Phycobilin to Chla ratio (µg:µg)", x = "Growth wavelength (nm)") +
  ggh4x::facet_nested(rows = vars(factor(Oxygen, levels=c("250~µM","2.5~µM"))), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.spacing.x = unit(0.4, 'cm'),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.key = element_blank(),
        legend.title = element_blank(),
        legend.position = c(0.10,0.90),
        legend.text = element_text(size=10))

```
# Save plot 

```{r save plot}
ggsave(file = file.path(FigPath, paste("Fig_PhycoChla",".png",sep = "")), height=5.5, width= 6,  dpi = 300, limitsize = TRUE)
```

---------------------------------



# Preparing df for pigment per cell plot

```{r Combine Chla, phyco, and Car in one column for final plot}
MCPigment1<-MCPigmentChoosen %>%
  select(-c(Chlapgcell, Carpgcell)) %>%
  mutate(Pigmentspgcell=Phycopgcell*1) %>%
  select(-c(Phycopgcell))
MCPigment1$PigmentsName = "Total~Phyco"

MCPigment2<-MCPigmentChoosen %>%
  select(-c(Phycopgcell, Carpgcell)) %>%
  mutate(Pigmentspgcell=Chlapgcell*1) %>%
  select(-c(Chlapgcell))
MCPigment2$PigmentsName = "Chl~a"

MCPigment3<-MCPigmentChoosen %>%
  select(-c(Chlapgcell, Phycopgcell)) %>%
  mutate(Pigmentspgcell=Carpgcell*1) %>%
  select(-c(Carpgcell))
MCPigment3$PigmentsName = "Car"

MCPigmentPlot<-rbind(MCPigment1, MCPigment2, MCPigment3)

rm(MCPigment1, MCPigment2, MCPigment3)
```

# Create pigments per cell plot - pigments photon dose

```{r Final pigments per cell plot}
lab1=c(expression("PC-rich_077"), expression("PE-rich_127"))
MCPigmentPlot %>%
  # mutate(WLNum = if_else(WL == "WW", 750, as.numeric(WL))) %>%
  # filter(WL != "WW") %>%
  filter(E_days == 7 | E_days == 8| E_days == 6 | E_days == 5| E_days == 10) %>% 
  ggplot() +
  geom_point(aes(x = WL, y = Pigmentspgcell, colour = as.factor(Strain), shape = as.factor(Photoperiod)),  alpha = 0.8, size = 3, show.legend = T) +
  scale_colour_manual(values = c("palegreen3", "brown4"), name="", labels = lab1) +
  scale_shape_manual(values = c(16, 18), name="", labels = lab1) +
  scale_linetype_manual(values = c("solid", "dashed"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(PigmentsName), rows = vars(factor(Oxygen, levels=c("250~µM","2.5~µM"))), labeller = label_parsed) +
  theme_bw() 

```



# Save plot 

```{r save plot}
# ggsave(file = file.path(FigPath, paste("SFig_Pigment",".png",sep = "")), height=9, width= 7,  dpi = 300, limitsize = TRUE)
```


# Cleaning df before saving as Rds and removed unnecessary files from the environment

```{r Cleaning the environment}
rm(MCPigmentPlot)
```



# Change variable names to know that these columns include onlychoosen Exp data

```{r}
MCPigmenttMaxAGExp<-MCPigmenttMaxAGExp %>%
  mutate(PURPARRatioExp = PURPARRatio) %>%
  mutate(cellL_OD680Exp = cellL_OD680) %>%
  mutate(ChlapgcellExp = Chlapgcell) %>%
  mutate(PhycopgcellExp = Phycopgcell) %>%
  mutate(E_daysExp = E_days) %>%
  mutate(Time_hExp = Time_h) %>%
  mutate(PhycoChlaRatioExp = PhycopgcellExp/ChlapgcellExp) %>%
  select(-c(PURPARRatio, cellL_OD680, Chlapgcell, Phycopgcell, E_days, Time_h))
```



# Save rds for further analysis

```{r save rds}
saveRDS(MCPigmentAll, file.path(DataOut, paste(Project, "Processed_PigmentsAll.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(MCPigmenttMaxAGExp, file.path(DataOut, paste(Project, "Processed_PigmentsExp.Rds", sep = "_"), fsep = .Platform$file.sep))
```

# Variable names used in Data Dictionary

```{r}
colnames(MCPigmentAll)
```

# Variable names used in Data Dictionary

```{r}
colnames(MCPigmenttMaxAGExp)
```




